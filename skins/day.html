<% extends skins/base.html %>

<% subskin head %>
<script type="text/javascript" src="/static/org/cometd.js"></script>
<script type="text/javascript" src="/static/jquery/jquery-1.3.2.js"></script>
<script type="text/javascript" src="/static/jquery/jquery.json-2.2.js"></script>
<script type="text/javascript" src="/static/jquery/jquery.cometd.js"></script>
<script type="text/javascript" src="/static/hiccup.js"></script>
<script type="text/javascript">

$(document).ready(function() {

    var connected, subscription;

    function record(r) {
        return $.hiccup(
          "p.utterance",
            ["span.time", "[", r.datetime.substring(11, 16), "]"],
            r.type === "message" ?
              ["span.is_message",
                ["span.sender", " &lt;", r.sender, "&gt; "],
                ["span.message", r.message]] :
              ["span.is_action", " * ",
                ["span.sender", " ", r.sender, " "],
                ["span.action", r.action]]);
    }

    function receive(msg) {
        var atBottom = $(document).height() - $(window).scrollTop() == $(window).height();
        $('div#content').append(record(msg.data));
        // scroll to new element if we're at the bottom of the page
        if (atBottom) {
            $('html, body').animate({scrollTop: $(window).scrollTop() + 50});
        }
    }

    $.cometd.configure({
        url: location.protocol + "//" + location.host + "/cometd",
        logLevel: 'warn'
    });

    $.cometd.addListener('/meta/connect', function(msg) {
        if (!connected && msg.successful) {
            connected = true;
            $.cometd.batch(function() {
                /* if (subscription) {
                    $.cometd.unsubscribe('/irc');
                } */
                subscription = $.cometd.subscribe('/irc', receive);
            });
        } else if (!msg.successful) {
            connected = false;
        }
    });

    $.cometd.handshake();
});

</script>
<style type="text/css">
    p.utterance {
        margin: 0;
    }
    span.is_action {
        font-style: italic;
    }
</style>

<% subskin content %>
<p>Logs for the <a href="irc://irc.freenode.net/ringojs">RingoJS IRC channel</a>, as logged by <a href="http://github.com/earl/ringobot"><code>ringostarr</code></a>.</p>

<h1><% day %></h1>
<% records %>

<% subskin menu %>
<% days %>
